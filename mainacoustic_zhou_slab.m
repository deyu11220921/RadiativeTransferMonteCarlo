%% Zhou 2021 Figure 4(b) Reproduction - Finite Slab (Thin Plate) Case
% Target: Anomalous Transport at L/ls = 3 (Ballistic & Diffusion Peaks Merge)

clear; clc; close all;

%% 1. Geometry (Slab = Wide Cylinder)
% ????: Slab ?? L = 10mm, ?? W = 4L = 40mm
L_sample = 10e-3;        
r_sample = 20e-3; % ?? r = W/2 = 20mm

geometry = struct('dimension', 3, ...
                  'frame', 'cylindrical'); 

% ??????? (Perfect Boundaries) ????? (Reverberations)
% dir=3 -> Z???, dir=4 -> R????
geometry.bnd(1) = struct('dir', 3, 'val', 0);          % Bottom (Z=0) ???
geometry.bnd(2) = struct('dir', 3, 'val', L_sample);   % Top (Z=L) ???
geometry.bnd(3) = struct('dir', 4, 'val', r_sample);   % Lateral (R=20mm) ??

%% 2. Point Source (??????)
% ????: ?????? Z ? [0 0 1], ?????????
source = struct('numberParticles', 1e6, ... % ???
                'type', 'point', ...
                'position', [0 0 0], ...    % ??????
                'direction', [0 0 1], ...   % ??: ??????
                'radial', 0, ...
                'lambda', 1e-4); 

%% 3. Observation (???? - ????? Bug)
% ??????????????“????”(0D)??????????? Bin ? > 1?
% ?? initializeObservation ??? ibins ????? "Matrix dimensions must agree"?
% 
% ???????? Y (Phi) ??????? Bin ([-pi 0] ? [0 pi])?
% ???????????? 2D ??????????
% ????????????????????????

% Z? (Depth): ?? Z=L ??????
dz = 0.1e-3; 
obs_z_bins = [L_sample-dz, L_sample+dz]; 

% X? (Radius): ????? [0, 2mm]
detector_radius = 2e-3; 
obs_r_bins = [0 detector_radius]; 

% ?????? Y? (Phi): 
% ??? [-Inf Inf] ????????1. ?? 2. ?????? Inf ?? 0?
% ???? [-pi 0 pi]??? 2 ? Bin?????????????
obs_phi = [-pi 0 pi]; 

% Time (??): ????? t/tb
V_wave = 450; 
tb = L_sample / V_wave; 
obs_time = 0 : (tb/50) : (20 * tb); 

observation = struct('x', obs_r_bins, ...    % Dimension 1: Radius
                     'y', obs_phi, ...       % Dimension 2: Phi (Dummy split)
                     'z', obs_z_bins, ...    % Dimension 3: Depth
                     'directions', [0 pi], ... 
                     'time', obs_time);

%% 4. Material Properties (????)
freq = 1e6;        
acoustics = true; 
corr_func = 'exp'; 

% =======================================================
% ???: ?????
% ??: L/ls = 3  =>  ls = 10mm / 3 ? 3.33 mm
calibrated_variance = 0.123;   % <--- ?????????
calibrated_corr_len = 0.0003;  % <--- ?????????
% =======================================================

material = MaterialClass(geometry, freq, acoustics, V_wave, ...
                         [calibrated_variance calibrated_variance], ...
                         -0.5, corr_func, calibrated_corr_len);

% ?????????? ls
fprintf('Preparing Scattering Matrix...\n');
material = prepareSigma(material, geometry.dimension);
ls_actual = material.meanFreePath;

fprintf('\n---------------- CHECK PARAMETERS ----------------\n');
fprintf('Target Ratio L/l_s = 3.0\n');
fprintf('Calculated l_s     = %.4f mm\n', ls_actual*1000);
fprintf('Actual Ratio L/l_s = %.2f\n', L_sample / ls_actual);
fprintf('--------------------------------------------------\n\n');

%% 5. Simulation (Running Code)
fprintf('Running Simulation (Finite Slab - On Axis Detection)...\n');
obs = radiativeTransferUnbounded(geometry, source, material, observation);

%% 6. Data Processing & Plotting
% ??? obs.energyDensity ????? [Nx, Ny, Nt]
% Nx = 1 (Radius), Ny = 2 (Phi split), Nt = Time

dims = size(obs.energyDensity);
fprintf('Output Energy Matrix Size: [%s]\n', num2str(dims));

% ??????
% ????? Phi ????? [-pi, 0] ? [0, pi]?????????
% ??????????????????????????????????????
% radiativeTransferUnbounded ?????? (J/m^3)?????????????????
% ??????????????

% ????: (Radial_Bin, Phi_Bin, Time)
% ?????? Bin???????(Phi)???
E_on_axis = squeeze(mean(obs.energyDensity(1, :, :), 2)); 

% ??????
t_norm = obs.t / tb;

% ??
figure('Color', 'w', 'Name', 'Zhou 2021 Fig 4b Reproduction');

% ??????? (Semilogy)
semilogy(t_norm, E_on_axis, 'b-', 'LineWidth', 2); 

grid on;
xlabel('Normalized Time (t / t_b)', 'FontSize', 12);
ylabel('Energy Density (J/m^3)', 'FontSize', 12);
title({['Finite Slab On-Axis (L/l_s \approx ' sprintf('%.1f', L_sample/ls_actual) ')']; ...
       'Expectation: Ballistic & Diffusion Peaks Merge'}, 'FontSize', 12);

% ?? Ballistic Arrival Time (t/tb = 1)
xline(1, 'k--', 'Ballistic Arrival', 'LineWidth', 1.5);

% ????????????
xlim([0 20]);